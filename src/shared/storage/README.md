## Storage guidelines (web + native)

This app uses `@react-native-async-storage/async-storage` (via `storageKv`) for
cross-platform key/value persistence.

### What to store here

- **Good fits**: small, non-sensitive settings and UI state
  - Examples: theme, map preferences, last-selected terminal, debug toggles
- **Avoid**: secrets or long-lived credentials
  - On native, use `expo-secure-store` for secrets (not supported on web).
  - On web, treat anything in JS-accessible storage as XSS-readable.

### Key naming + versioning

- Always use namespaced keys generated by `storageKv.makeKey()`:
  - Format: `fj:<scope>:<version>:<key>`
  - Example: `fj:settings:v1:theme`
- Bump the `version` when the persisted valueâ€™s shape changes incompatibly.
  - Prefer a new versioned key over in-place mutation.

### Hydration (important)

- Storage reads are async across platforms.
- **Do not** read from storage during render.
- Use `usePersistentState(...).isHydrated` to gate logic/UI when needed.

### Validation + corruption handling

- Prefer schema validation on reads:
  - `storageKv.getJson(key, { schema })`
  - `usePersistentState(key, { defaultValue, schema })`
- Invalid/corrupt data should be removed by default (`onInvalid: "remove"`).

### Size + performance

- Keep values small and JSON-serializable.
- Persist the minimum necessary state; derive everything else at runtime.

